<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>–°–¥–∞—á–∞ –¥–µ–Ω–µ–≥</title>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <style>
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial; margin: 0; padding: 16px; }
    h2 { margin: 8px 0 16px; }
    .card { border: 1px solid #ddd; border-radius: 14px; padding: 14px; }
    label { display:block; margin: 10px 0 6px; font-size: 14px; }
    input, select, textarea {
      width: 100%; box-sizing: border-box; padding: 10px 12px; border-radius: 10px;
      border: 1px solid #ccc; font-size: 16px;
    }
    textarea { min-height: 72px; }
    .row { display:flex; gap:10px; }
    .row > div { flex:1; }
    .error { color: #b00020; margin-top: 10px; font-size: 14px; }
    .hint { color:#666; font-size: 13px; margin-top: 8px; }
    
    /* –°—Ç–∏–ª–∏ –∫–Ω–æ–ø–æ–∫ */
    button {
      width: 100%; margin-top: 14px; padding: 12px; font-size: 16px;
      border-radius: 12px; border: none; cursor: pointer;
      font-weight: 500;
    }
    .btn-primary {
      background-color: var(--tg-theme-button-color, #2481cc);
      color: var(--tg-theme-button-text-color, #ffffff);
    }
    .btn-outline {
      background-color: transparent;
      border: 2px solid var(--tg-theme-button-color, #2481cc);
      color: var(--tg-theme-text-color, #000);
      margin-top: 10px;
    }
    /* –°—Ç–∏–ª—å –¥–ª—è –∫–Ω–æ–ø–∫–∏ –≤–æ–ø—Ä–æ—Å–∞ (–æ—Ä–∞–Ω–∂–µ–≤—ã–π/–∫—Ä–∞—Å–Ω—ã–π –æ—Ç—Ç–µ–Ω–æ–∫) */
    .btn-question {
      background-color: transparent;
      border: 2px solid #e67e22; 
      color: #e67e22;
      margin-top: 25px;
    }

    .hidden { display: none; }
  </style>
</head>
<body>

  <!-- –®–ê–ì 1: –í–´–ë–û–† –û–ü–õ–ê–¢–´ -->
  <div id="step1">
    <h2>–®–∞–≥ 1: –û–ø–ª–∞—Ç–∞</h2>
    <div class="card">
      <p>–°–Ω–∞—á–∞–ª–∞ –≤—ã–±–µ—Ä–∏—Ç–µ –≤–∞—Ä–∏–∞–Ω—Ç –æ–ø–ª–∞—Ç—ã:</p>
      
      <button class="btn-outline" onclick="openPayment('https://messenger.online.sberbank.ru/sl/fphFphF74XMKE2qb9')">
        üí≥ –°–±–µ—Ä–±–∞–Ω–∫
      </button>
      
      <button class="btn-outline" onclick="openPayment('https://www.tbank.ru/cf/3J5xZhnK6cY')">
        üí≥ –¢-–ë–∞–Ω–∫
      </button>

      <br><br>
      <div class="hint">–ü–æ—Å–ª–µ –æ–ø–ª–∞—Ç—ã –Ω–∞–∂–º–∏—Ç–µ –∫–Ω–æ–ø–∫—É –Ω–∏–∂–µ, —á—Ç–æ–±—ã –∑–∞–ø–æ–ª–Ω–∏—Ç—å –¥–∞–Ω–Ω—ã–µ –æ –ø–ª–∞—Ç–µ–∂–µ.</div>
      
      <button class="btn-primary" id="goToFormBtn">
        –Ø –æ–ø–ª–∞—Ç–∏–ª, –∑–∞–ø–æ–ª–Ω–∏—Ç—å —Ñ–æ—Ä–º—É üëâ
      </button>

      <!-- –ù–û–í–ê–Ø –ö–ù–û–ü–ö–ê –í–û–ü–†–û–°–ê -->
      <button class="btn-question" id="askBtn">
        ‚ùì –£ –º–µ–Ω—è –≤–æ–ø—Ä–æ—Å / –ø—Ä–æ–±–ª–µ–º–∞
      </button>
    </div>
  </div>

  <!-- –®–ê–ì 2: –í–ê–®–ê –§–û–†–ú–ê -->
  <div id="step2" class="hidden">
    <h2>–®–∞–≥ 2: –î–∞–Ω–Ω—ã–µ</h2>

    <div class="card">
      <div class="row">
        <div>
          <label>–£—á–∞—Å—Ç–æ–∫ *</label>
          <input id="plot" inputmode="numeric" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: 328" />
        </div>
        <div>
          <label>–°–±–æ—Ä *</label>
          <select id="collection">
            <option value="">–í—ã–±–µ—Ä–∏‚Ä¶</option>
            <option value="2">–°–±–æ—Ä 2</option>
            <option value="3">–°–±–æ—Ä 3</option>
          </select>
        </div>
      </div>

      <label>–°—É–º–º–∞ (‚ÇΩ) *</label>
      <input id="amount" inputmode="decimal" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: 1000" />

      <label>–ë–∞–Ω–∫ (–Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)</label>
      <input id="bank" placeholder="–°–±–µ—Ä / –¢–∏–Ω—å–∫–æ—Ñ—Ñ / SBP‚Ä¶" />

      <label>–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π (–Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)</label>
      <textarea id="comment" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: –∏ 329, 330 / –ø–µ—Ä–µ—á–∏—Å–ª–∏ –Ω–æ–º–µ—Ä–∞ / —É—Ç–æ—á–Ω–µ–Ω–∏–µ"></textarea>

      <div class="hint" style="color: #d32f2f; font-size: 16px; font-weight: bold; text-align: center; margin: 15px 0;">
        ‚ö†Ô∏è –ü–æ—Å–ª–µ –æ—Ç–ø—Ä–∞–≤–∫–∏ –±–æ—Ç –ø–æ–ø—Ä–æ—Å–∏—Ç –ø—Ä–∏—Å–ª–∞—Ç—å —á–µ–∫ (—Ñ–æ—Ç–æ/–ø–¥—Ñ) –≤ —ç—Ç–æ—Ç –∂–µ —á–∞—Ç.
      </div>
      <div id="err" class="error"></div>

      <button id="sendBtn" class="btn-primary">–û—Ç–ø—Ä–∞–≤–∏—Ç—å –∑–∞—è–≤–∫—É</button>
      
      <button onclick="goBack()" style="background:none; color:#888; font-size:14px; margin-top:5px;">
        ‚Üê –í–µ—Ä–Ω—É—Ç—å—Å—è –∫ –æ–ø–ª–∞—Ç–µ
      </button>
    </div>
  </div>

  <script>
    const tg = window.Telegram.WebApp;
    tg.ready();
    tg.expand();

    const mainButtonColor = tg.themeParams.button_color || "#2481cc";
    const mainButtonText = tg.themeParams.button_text_color || "#ffffff";
    
    document.body.style.background = tg.themeParams.bg_color || "#fff";
    document.body.style.color = tg.themeParams.text_color || "#000";

    document.querySelectorAll('.btn-primary').forEach(b => {
        b.style.backgroundColor = mainButtonColor;
        b.style.color = mainButtonText;
    });
    document.querySelectorAll('.btn-outline').forEach(b => {
        b.style.borderColor = mainButtonColor;
        b.style.color = tg.themeParams.text_color || "#000";
    });

    const step1 = document.getElementById('step1');
    const step2 = document.getElementById('step2');

    // URL –í–ê–®–ï–ì–û WEBHOOK (–û–¥–∏–Ω –Ω–∞ –≤—Å—ë)
    const WEBHOOK_URL = 'https://www.maximdkh.ru/webhook/sneg-form'; 

    window.openPayment = (url) => { tg.openLink(url); };

    document.getElementById('goToFormBtn').onclick = () => {
        step1.classList.add('hidden');
        step2.classList.remove('hidden');
        tg.BackButton.show();
        tg.BackButton.onClick(goBack);
    };

    window.goBack = () => {
        step2.classList.add('hidden');
        step1.classList.remove('hidden');
        tg.BackButton.hide();
    };

    // --- –õ–û–ì–ò–ö–ê –ö–ù–û–ü–ö–ò "–ó–ê–î–ê–¢–¨ –í–û–ü–†–û–°" ---
    document.getElementById('askBtn').onclick = () => {
        const btn = document.getElementById('askBtn');
        btn.disabled = true;
        btn.textContent = "–°–æ–æ–±—â–∞—é –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä—É...";

        const payload = {
            type: "question", // <--- –ì–õ–ê–í–ù–û–ï –û–¢–õ–ò–ß–ò–ï
            user: tg.initDataUnsafe?.user
        };

        fetch(WEBHOOK_URL, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(payload)
        })
        .then(() => {
            tg.close();
        })
        .catch(() => {
            alert("–û—à–∏–±–∫–∞ —Å–µ—Ç–∏. –ù–∞–ø–∏—à–∏—Ç–µ –ø—Ä–æ—Å—Ç–æ –≤ —á–∞—Ç.");
            tg.close();
        });
    };

    // --- –õ–û–ì–ò–ö–ê –§–û–†–ú–´ –û–ü–õ–ê–¢–´ ---
    const plotEl = document.getElementById("plot");
    const amountEl = document.getElementById("amount");
    const collectionEl = document.getElementById("collection");
    const bankEl = document.getElementById("bank");
    const commentEl = document.getElementById("comment");
    const errEl = document.getElementById("err");
    const sendBtn = document.getElementById("sendBtn");

    function onlyDigits(s) { return String(s).replace(/[^\d]/g, ""); }
    function normAmount(s) { return String(s).replace(",", ".").replace(/[^\d.]/g, ""); }

    sendBtn.onclick = () => {
      errEl.textContent = "";

      const plot = onlyDigits(plotEl.value);
      const collection = collectionEl.value;
      const amountRaw = normAmount(amountEl.value);
      const amount = Number(amountRaw);

      if (!plot) return errEl.textContent = "–£–∫–∞–∂–∏ –Ω–æ–º–µ—Ä —É—á–∞—Å—Ç–∫–∞.";
      if (!collection) return errEl.textContent = "–í—ã–±–µ—Ä–∏ –Ω–æ–º–µ—Ä —Å–±–æ—Ä–∞.";
      if (!amountRaw || !Number.isFinite(amount) || amount <= 0) return errEl.textContent = "–£–∫–∞–∂–∏ –∫–æ—Ä—Ä–µ–∫—Ç–Ω—É—é —Å—É–º–º—É.";

      const payload = {
        type: "payment_form", // <--- –û–ë–´–ß–ù–´–ô –¢–ò–ü
        plot: Number(plot),
        collection: Number(collection),
        amount: Math.round(amount * 100) / 100,
        bank: bankEl.value?.trim() || "",
        comment: commentEl.value?.trim() || "",
        client_ts: new Date().toISOString(),
        user: tg.initDataUnsafe?.user
      };
      
      sendBtn.disabled = true;
      sendBtn.textContent = "–û—Ç–ø—Ä–∞–≤–∫–∞...";

      fetch(WEBHOOK_URL, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(payload)
      })
      .then(response => {
        if (response.ok) {
           tg.close(); 
        } else {
           errEl.textContent = "–û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞: " + response.status;
           sendBtn.disabled = false;
           sendBtn.textContent = "–û—Ç–ø—Ä–∞–≤–∏—Ç—å";
        }
      })
      .catch(error => {
        errEl.textContent = "–û—à–∏–±–∫–∞ —Å–µ—Ç–∏: " + error.message;
        sendBtn.disabled = false;
        sendBtn.textContent = "–û—Ç–ø—Ä–∞–≤–∏—Ç—å";
      });
    };
  </script>
</body>
</html>
