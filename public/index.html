<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>–°–¥–∞—á–∞ –¥–µ–Ω–µ–≥</title>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <style>
    /* –ë–∞–∑–æ–≤—ã–µ —Å—Ç–∏–ª–∏ */
    body { 
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial; 
      margin: 0; 
      padding: 16px; 
      box-sizing: border-box; 
      /* –£–±—Ä–∞–ª–∏ –ª–∏—à–Ω–∏–π –æ—Ç—Å—Ç—É–ø —Å–Ω–∏–∑—É, —Ç–∞–∫ –∫–∞–∫ —Ñ—É—Ç–µ—Ä —Ç–µ–ø–µ—Ä—å —á–∞—Å—Ç—å –ø–æ—Ç–æ–∫–∞ */
      padding-bottom: 20px; 
    }
    
    h2 { margin: 8px 0 16px; }
    
    /* –ö–∞—Ä—Ç–æ—á–∫–∞ */
    .card { 
      border: 1px solid rgba(0,0,0,0.05); 
      border-radius: 14px; 
      padding: 14px; 
      margin-bottom: 12px; 
    }

    /* –û–±—ã—á–Ω—ã–π —Ç–µ–∫—Å—Ç –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏ */
    .instruction-text {
      margin: 0 0 10px 0;
      font-size: 16px;
      line-height: 1.4;
      color: var(--tg-theme-text-color, #000);
    }

    /* –ó–∞–≥–æ–ª–æ–≤–∫–∏ –ø–æ–ª–µ–π */
    label { 
      display:block; 
      margin: 12px 0 6px; 
      font-size: 14px; 
      color: var(--tg-theme-hint-color, #999); 
      opacity: 0.7; 
    }

    /* –ü–æ–ª—è –≤–≤–æ–¥–∞ */
    input, select, textarea {
      width: 100%; 
      box-sizing: border-box; 
      padding: 12px; 
      border-radius: 10px;
      border: 1px solid rgba(0,0,0,0.1); 
      font-size: 16px;
      background-color: var(--tg-theme-bg-color, #fff); 
      color: var(--tg-theme-text-color, #000);
    }
    
    /* === –ò–ó–ú–ï–ù–ï–ù–ò–ï 1: –°–¥–µ–ª–∞–ª–∏ –ø–æ–¥—Å–∫–∞–∑–∫–∏ –≤–Ω—É—Ç—Ä–∏ –ø–æ–ª–µ–π –µ–ª–µ –∑–∞–º–µ—Ç–Ω—ã–º–∏ === */
    input::placeholder, textarea::placeholder {
      color: var(--tg-theme-hint-color, #a8a8a8);
      opacity: 0.2; /* –ë—ã–ª–æ 0.6, —Å—Ç–∞–ª–æ 0.2 (–æ—á–µ–Ω—å —Å–≤–µ—Ç–ª–æ) */
    }

    textarea { min-height: 72px; }
    .row { display:flex; gap:10px; }
    .row > div { flex:1; }
    .error { color: #b00020; margin-top: 10px; font-size: 14px; }
    
    /* –í–∞–∂–Ω–∞—è –ø–æ–¥—Å–∫–∞–∑–∫–∞ (–∫—Ä–∞—Å–Ω–∞—è) */
    .hint-warning { 
      color: #d32f2f; 
      font-size: 15px; 
      font-weight: bold; 
      text-align: center; 
      margin: 15px 0; 
      opacity: 0.9;
    }

    /* –°—Ç–∏–ª–∏ –∫–Ω–æ–ø–æ–∫ */
    button {
      width: 100%; padding: 12px; font-size: 16px;
      border-radius: 12px; border: none; cursor: pointer;
      font-weight: 500;
    }
    
    .btn-primary {
      background-color: var(--tg-theme-button-color, #2481cc);
      color: var(--tg-theme-button-text-color, #ffffff);
      margin-top: 14px;
    }
    
    .btn-red {
      background-color: #d32f2f; 
      color: #ffffff;            
      font-weight: bold;
      font-size: 17px;
      margin-top: 10px;
    }

    .btn-outline {
      background-color: transparent;
      border: 2px solid var(--tg-theme-button-color, #2481cc);
      color: var(--tg-theme-text-color, #000);
      margin-bottom: 10px; 
    }
    
    .footer-section {
      margin-top: 20px;
      text-align: center;
    }
    .btn-question {
      background-color: transparent;
      border: 1px solid #e67e22; 
      color: #e67e22;
      font-size: 15px;
      padding: 10px;
    }

    /* === –ò–ó–ú–ï–ù–ï–ù–ò–ï 2: –ö–æ–ø–∏—Ä–∞–π—Ç —Ç–µ–ø–µ—Ä—å –ø—Ä–æ—Å—Ç–æ –≤–Ω–∏–∑—É —Å—Ç—Ä–∞–Ω–∏—Ü—ã (–Ω–µ –ø—Ä–∏–ª–∏–ø–∞–µ—Ç) === */
    .copyright {
      display: block;
      text-align: center;
      margin-top: 30px; /* –û—Ç—Å—Ç—É–ø –æ—Ç –∫–æ–Ω—Ç–µ–Ω—Ç–∞ */
      margin-bottom: 10px;
      font-size: 13px;
      color: var(--tg-theme-hint-color, #999);
      text-decoration: none;
      opacity: 0.5;
    }
    .copyright:hover {
      opacity: 1;
      color: var(--tg-theme-button-color, #2481cc);
    }

    .hidden { display: none; }
  </style>
</head>
<body>

  <!-- –®–ê–ì 1: –í–´–ë–û–† –û–ü–õ–ê–¢–´ -->
  <div id="step1">
    <h2>–®–∞–≥ 1: –û–ø–ª–∞—Ç–∞</h2>
    
    <div class="card">
      <p class="instruction-text">–°–Ω–∞—á–∞–ª–∞ –≤—ã–±–µ—Ä–∏—Ç–µ –≤–∞—Ä–∏–∞–Ω—Ç –æ–ø–ª–∞—Ç—ã:</p>
      
      <button class="btn-outline" onclick="openPayment('https://messenger.online.sberbank.ru/sl/fphFphF74XMKE2qb9')">
        üí≥ –°–±–µ—Ä–±–∞–Ω–∫
      </button>
      
      <button class="btn-outline" onclick="openPayment('https://www.tbank.ru/cf/3J5xZhnK6cY')">
        üí≥ –¢-–ë–∞–Ω–∫
      </button>
    </div>

    <h2>–®–∞–≥ 2: –§–æ—Ä–º–∞</h2>

    <div class="card">
      <p class="instruction-text">
        –ü–æ—Å–ª–µ –æ–ø–ª–∞—Ç—ã –Ω–∞–∂–º–∏—Ç–µ –∫–Ω–æ–ø–∫—É –Ω–∏–∂–µ, —á—Ç–æ–±—ã –∑–∞–ø–æ–ª–Ω–∏—Ç—å –¥–∞–Ω–Ω—ã–µ –æ –ø–ª–∞—Ç–µ–∂–µ. üëá
      </p>
      
      <button class="btn-red" id="goToFormBtn">
        –Ø –æ–ø–ª–∞—Ç–∏–ª, –∑–∞–ø–æ–ª–Ω–∏—Ç—å —Ñ–æ—Ä–º—É üëâ
      </button>
    </div>

    <div class="footer-section">
      <button class="btn-question" id="askBtn">
        ‚ùì –£ –º–µ–Ω—è –≤–æ–ø—Ä–æ—Å / –ø—Ä–æ–±–ª–µ–º–∞
      </button>
    </div>
  </div>

  <!-- –®–ê–ì 2: –ê–ù–ö–ï–¢–ê -->
  <div id="step2" class="hidden">
    <h2>–®–∞–≥ 2: –ê–Ω–∫–µ—Ç–∞</h2>

    <div class="card">
      <div class="row">
        <div>
          <label>–£—á–∞—Å—Ç–æ–∫ *</label>
          <input id="plot" inputmode="numeric" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: 328" />
        </div>
        <div>
          <label>–°–±–æ—Ä *</label>
          <select id="collection">
            <option value="">–í—ã–±–µ—Ä–∏‚Ä¶</option>
            <option value="2">–°–±–æ—Ä 2</option>
            <option value="3">–°–±–æ—Ä 3</option>
          </select>
        </div>
      </div>

      <label>–°—É–º–º–∞ (‚ÇΩ) *</label>
      <input id="amount" inputmode="decimal" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: 1000" />

      <label>–ë–∞–Ω–∫ *</label>
      <input id="bank" placeholder="–°–±–µ—Ä / –¢–∏–Ω—å–∫–æ—Ñ—Ñ / SBP‚Ä¶" />

      <label>–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π (–Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)</label>
      <textarea id="comment" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: –∏ 329, 330 / –ø–µ—Ä–µ—á–∏—Å–ª–∏ –Ω–æ–º–µ—Ä–∞ / —É—Ç–æ—á–Ω–µ–Ω–∏–µ"></textarea>

      <div class="hint-warning">
        ‚ö†Ô∏è –ü–æ—Å–ª–µ –æ—Ç–ø—Ä–∞–≤–∫–∏ –±–æ—Ç –ø–æ–ø—Ä–æ—Å–∏—Ç –ø—Ä–∏—Å–ª–∞—Ç—å —á–µ–∫ (—Ñ–æ—Ç–æ/–ø–¥—Ñ) –≤ —ç—Ç–æ—Ç –∂–µ —á–∞—Ç.
      </div>
      
      <div id="err" class="error"></div>

      <button id="sendBtn" class="btn-primary">–û—Ç–ø—Ä–∞–≤–∏—Ç—å –∑–∞—è–≤–∫—É</button>
      
      <button onclick="goBack()" style="background:none; color:#888; font-size:14px; margin-top:5px;">
        ‚Üê –í–µ—Ä–Ω—É—Ç—å—Å—è –∫ –æ–ø–ª–∞—Ç–µ
      </button>
    </div>
  </div>

  <!-- –ö–û–ü–ò–†–ê–ô–¢ –¢–ï–ü–ï–†–¨ –í–ù–ò–ó–£ –ü–û–¢–û–ö–ê (–ù–ï –ó–ê–ö–†–ï–ü–õ–ï–ù) -->
  <a href="https://t.me/AI_MAX_AI" class="copyright">–°–æ–∑–¥–∞–Ω–æ @AI_MAX_AI</a>

  <script>
    const tg = window.Telegram.WebApp;
    tg.ready();
    tg.expand();

    // === –ù–ê–°–¢–†–û–ô–ö–ê –¶–í–ï–¢–û–í ===
    const mainButtonColor = tg.themeParams.button_color || "#2481cc";
    const mainButtonText = tg.themeParams.button_text_color || "#ffffff";
    const textColor = tg.themeParams.text_color || "#000";
    const bgColor = tg.themeParams.bg_color || "#ffffff";
    
    const isDark = tg.colorScheme === 'dark';

    document.body.style.background = bgColor;
    document.body.style.color = textColor;

    // –¶–≤–µ—Ç –∫–∞—Ä—Ç–æ—á–µ–∫: –≤ —Å–≤–µ—Ç–ª–æ–π —Ç–µ–º–µ —á—É—Ç—å —Ç–µ–º–Ω–µ–µ –±–µ–ª–æ–≥–æ (#f4f4f5)
    document.querySelectorAll('.card').forEach(c => {
        if (isDark) {
            c.style.backgroundColor = tg.themeParams.secondary_bg_color || "#1c1c1d";
        } else {
            c.style.backgroundColor = "#f4f4f5"; 
        }
    });

    document.querySelectorAll('.btn-primary').forEach(b => {
        b.style.backgroundColor = mainButtonColor;
        b.style.color = mainButtonText;
    });
    document.querySelectorAll('.btn-outline').forEach(b => {
        b.style.borderColor = mainButtonColor;
        b.style.color = textColor;
    });

    const step1 = document.getElementById('step1');
    const step2 = document.getElementById('step2');
    const WEBHOOK_URL = 'https://www.maximdkh.ru/webhook/sneg-form'; 

    window.openPayment = (url) => { tg.openLink(url); };

    document.getElementById('goToFormBtn').onclick = () => {
        step1.classList.add('hidden');
        step2.classList.remove('hidden');
        tg.BackButton.show();
        tg.BackButton.onClick(goBack);
    };

    window.goBack = () => {
        step2.classList.add('hidden');
        step1.classList.remove('hidden');
        tg.BackButton.hide();
    };

    document.getElementById('askBtn').onclick = () => {
        const btn = document.getElementById('askBtn');
        btn.disabled = true;
        btn.textContent = "–°–æ–æ–±—â–∞—é –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä—É...";

        const payload = { type: "question", user: tg.initDataUnsafe?.user };

        fetch(WEBHOOK_URL, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(payload)
        })
        .then(() => { tg.close(); })
        .catch(() => { alert("–û—à–∏–±–∫–∞ —Å–µ—Ç–∏. –ù–∞–ø–∏—à–∏—Ç–µ –ø—Ä–æ—Å—Ç–æ –≤ —á–∞—Ç."); tg.close(); });
    };

    // --- –õ–û–ì–ò–ö–ê –§–û–†–ú–´ ---
    const plotEl = document.getElementById("plot");
    const amountEl = document.getElementById("amount");
    const collectionEl = document.getElementById("collection");
    const bankEl = document.getElementById("bank");
    const commentEl = document.getElementById("comment");
    const errEl = document.getElementById("err");
    const sendBtn = document.getElementById("sendBtn");

    function onlyDigits(s) { return String(s).replace(/[^\d]/g, ""); }
    function normAmount(s) { return String(s).replace(",", ".").replace(/[^\d.]/g, ""); }

    sendBtn.onclick = () => {
      errEl.textContent = "";

      const plotRaw = plotEl.value.trim();
      const bankRaw = bankEl.value.trim();
      const collection = collectionEl.value;
      const amountRaw = normAmount(amountEl.value);
      const amount = Number(amountRaw);

      if (plotRaw.includes(',') || plotRaw.includes('.') || plotRaw.includes(' ')) {
         return errEl.textContent = "–£–∫–∞–∂–∏ —Ç–æ–ª—å–∫–æ –æ–¥–∏–Ω –Ω–æ–º–µ—Ä —É—á–∞—Å—Ç–∫–∞ (–±–µ–∑ –∑–∞–ø—è—Ç—ã—Ö).";
      }
      
      const plot = onlyDigits(plotRaw);
      
      if (!plot) return errEl.textContent = "–£–∫–∞–∂–∏ –Ω–æ–º–µ—Ä —É—á–∞—Å—Ç–∫–∞.";
      if (plot.length > 3) return errEl.textContent = "–ù–æ–º–µ—Ä —É—á–∞—Å—Ç–∫–∞ –Ω–µ –º–æ–∂–µ—Ç –±—ã—Ç—å –¥–ª–∏–Ω–Ω–µ–µ 3 —Ü–∏—Ñ—Ä.";
      if (!collection) return errEl.textContent = "–í—ã–±–µ—Ä–∏ –Ω–æ–º–µ—Ä —Å–±–æ—Ä–∞.";
      if (!amountRaw || !Number.isFinite(amount) || amount <= 0) return errEl.textContent = "–£–∫–∞–∂–∏ –∫–æ—Ä—Ä–µ–∫—Ç–Ω—É—é —Å—É–º–º—É.";
      if (!bankRaw) return errEl.textContent = "–£–∫–∞–∂–∏ –±–∞–Ω–∫ –æ–ø–ª–∞—Ç—ã.";

      const payload = {
        type: "payment_form",
        plot: Number(plot),
        collection: Number(collection),
        amount: Math.round(amount * 100) / 100,
        bank: bankRaw, 
        comment: commentEl.value?.trim() || "",
        client_ts: new Date().toISOString(),
        user: tg.initDataUnsafe?.user
      };
      
      sendBtn.disabled = true;
      sendBtn.textContent = "–û—Ç–ø—Ä–∞–≤–∫–∞...";

      fetch(WEBHOOK_URL, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(payload)
      })
      .then(response => {
        if (response.ok) { tg.close(); } 
        else { 
           errEl.textContent = "–û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞: " + response.status;
           sendBtn.disabled = false;
           sendBtn.textContent = "–û—Ç–ø—Ä–∞–≤–∏—Ç—å";
        }
      })
      .catch(error => {
        errEl.textContent = "–û—à–∏–±–∫–∞ —Å–µ—Ç–∏: " + error.message;
        sendBtn.disabled = false;
        sendBtn.textContent = "–û—Ç–ø—Ä–∞–≤–∏—Ç—å";
      });
    };
  </script>
</body>
</html>
