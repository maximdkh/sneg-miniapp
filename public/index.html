<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>–°–¥–∞—á–∞ –¥–µ–Ω–µ–≥</title>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <style>
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial; margin: 0; padding: 16px; box-sizing: border-box;}
    h2 { margin: 8px 0 16px; }
    
    /* –ö–∞—Ä—Ç–æ—á–∫–∞ - –±–µ–ª—ã–π –±–ª–æ–∫ */
    .card { 
      border: 1px solid #ddd; 
      border-radius: 14px; 
      padding: 14px; 
      margin-bottom: 12px; 
    }

    /* –û–±—ã—á–Ω—ã–π —Ç–µ–∫—Å—Ç –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏ */
    .instruction-text {
      margin: 0 0 10px 0;
      font-size: 16px;
      line-height: 1.4;
      color: var(--tg-theme-text-color, #000);
    }

    label { display:block; margin: 10px 0 6px; font-size: 14px; }
    input, select, textarea {
      width: 100%; box-sizing: border-box; padding: 10px 12px; border-radius: 10px;
      border: 1px solid #ccc; font-size: 16px;
    }
    textarea { min-height: 72px; }
    .row { display:flex; gap:10px; }
    .row > div { flex:1; }
    .error { color: #b00020; margin-top: 10px; font-size: 14px; }
    
    /* –í–∞–∂–Ω–∞—è –ø–æ–¥—Å–∫–∞–∑–∫–∞ (–∫—Ä–∞—Å–Ω–∞—è) –≤–Ω—É—Ç—Ä–∏ —Ñ–æ—Ä–º—ã */
    .hint-warning { 
      color: #d32f2f; 
      font-size: 15px; 
      font-weight: bold; 
      text-align: center; 
      margin: 15px 0; 
    }

    /* –°—Ç–∏–ª–∏ –∫–Ω–æ–ø–æ–∫ */
    button {
      width: 100%; padding: 12px; font-size: 16px;
      border-radius: 12px; border: none; cursor: pointer;
      font-weight: 500;
    }
    
    /* –°—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–∞—è —Å–∏–Ω—è—è –∫–Ω–æ–ø–∫–∞ */
    .btn-primary {
      background-color: var(--tg-theme-button-color, #2481cc);
      color: var(--tg-theme-button-text-color, #ffffff);
      margin-top: 14px;
    }
    
    /* –ö—Ä–∞—Å–Ω–∞—è –∫–Ω–æ–ø–∫–∞ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è */
    .btn-red {
      background-color: #d32f2f; 
      color: #ffffff;            
      font-weight: bold;
      font-size: 17px;
      margin-top: 10px;
    }

    /* –ö–Ω–æ–ø–∫–∞ —Å—Å—ã–ª–∫–∏ (–ø—Ä–æ–∑—Ä–∞—á–Ω–∞—è) */
    .btn-outline {
      background-color: transparent;
      border: 2px solid var(--tg-theme-button-color, #2481cc);
      color: var(--tg-theme-text-color, #000);
      margin-bottom: 10px; 
    }
    
    /* –ö–Ω–æ–ø–∫–∞ –≤–æ–ø—Ä–æ—Å–∞ (–§—É—Ç–µ—Ä) */
    .footer-section {
      margin-top: 20px;
      text-align: center;
    }
    .btn-question {
      background-color: transparent;
      border: 1px solid #e67e22; /* –¢–æ–Ω–∫–∞—è —Ä–∞–º–∫–∞ */
      color: #e67e22;
      font-size: 15px;
      padding: 10px;
    }

    .hidden { display: none; }
  </style>
</head>
<body>

  <!-- –®–ê–ì 1: –í–´–ë–û–† –û–ü–õ–ê–¢–´ -->
  <div id="step1">
    <h2>–®–∞–≥ 1: –û–ø–ª–∞—Ç–∞</h2>
    
    <!-- –ë–õ–û–ö 1: –ë–∞–Ω–∫–∏ -->
    <div class="card">
      <p class="instruction-text">–°–Ω–∞—á–∞–ª–∞ –≤—ã–±–µ—Ä–∏—Ç–µ –≤–∞—Ä–∏–∞–Ω—Ç –æ–ø–ª–∞—Ç—ã:</p>
      
      <button class="btn-outline" onclick="openPayment('https://messenger.online.sberbank.ru/sl/fphFphF74XMKE2qb9')">
        üí≥ –°–±–µ—Ä–±–∞–Ω–∫
      </button>
      
      <button class="btn-outline" onclick="openPayment('https://www.tbank.ru/cf/3J5xZhnK6cY')">
        üí≥ –¢-–ë–∞–Ω–∫
      </button>
    </div>

    <!-- –ë–õ–û–ö 2: –ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ -->
    <div class="card">
      <p class="instruction-text">
        –ü–æ—Å–ª–µ –æ–ø–ª–∞—Ç—ã –Ω–∞–∂–º–∏—Ç–µ –∫–Ω–æ–ø–∫—É –Ω–∏–∂–µ, —á—Ç–æ–±—ã –∑–∞–ø–æ–ª–Ω–∏—Ç—å –¥–∞–Ω–Ω—ã–µ –æ –ø–ª–∞—Ç–µ–∂–µ. üëá
      </p>
      
      <button class="btn-red" id="goToFormBtn">
        –Ø –æ–ø–ª–∞—Ç–∏–ª, –∑–∞–ø–æ–ª–Ω–∏—Ç—å —Ñ–æ—Ä–º—É üëâ
      </button>
    </div>

    <!-- –§–£–¢–ï–†: –í–æ–ø—Ä–æ—Å -->
    <div class="footer-section">
      <button class="btn-question" id="askBtn">
        ‚ùì –£ –º–µ–Ω—è –≤–æ–ø—Ä–æ—Å / –ø—Ä–æ–±–ª–µ–º–∞
      </button>
    </div>
  </div>

  <!-- –®–ê–ì 2: –í–ê–®–ê –§–û–†–ú–ê -->
  <div id="step2" class="hidden">
    <h2>–®–∞–≥ 2: –ê–Ω–∫–µ—Ç–∞</h2>

    <div class="card">
      <div class="row">
        <div>
          <label>–£—á–∞—Å—Ç–æ–∫ *</label>
          <!-- –û–±–Ω–æ–≤–∏–ª–∏ placeholder –¥–ª—è —è—Å–Ω–æ—Å—Ç–∏ -->
          <input id="plot" inputmode="numeric" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: 328" />
        </div>
        <div>
          <label>–°–±–æ—Ä *</label>
          <select id="collection">
            <option value="">–í—ã–±–µ—Ä–∏‚Ä¶</option>
            <option value="2">–°–±–æ—Ä 2</option>
            <option value="3">–°–±–æ—Ä 3</option>
          </select>
        </div>
      </div>

      <label>–°—É–º–º–∞ (‚ÇΩ) *</label>
      <input id="amount" inputmode="decimal" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: 1000" />

      <!-- –°–¥–µ–ª–∞–ª–∏ –ø–æ–ª–µ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–º –≤ HTML (–≤–∏–∑—É–∞–ª—å–Ω–æ) -->
      <label>–ë–∞–Ω–∫ *</label>
      <input id="bank" placeholder="–°–±–µ—Ä / –¢–∏–Ω—å–∫–æ—Ñ—Ñ / SBP‚Ä¶" />

      <label>–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π (–Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)</label>
      <textarea id="comment" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: –∏ 329, 330 / –ø–µ—Ä–µ—á–∏—Å–ª–∏ –Ω–æ–º–µ—Ä–∞ / —É—Ç–æ—á–Ω–µ–Ω–∏–µ"></textarea>

      <div class="hint-warning">
        ‚ö†Ô∏è –ü–æ—Å–ª–µ –æ—Ç–ø—Ä–∞–≤–∫–∏ –±–æ—Ç –ø–æ–ø—Ä–æ—Å–∏—Ç –ø—Ä–∏—Å–ª–∞—Ç—å —á–µ–∫ (—Ñ–æ—Ç–æ/–ø–¥—Ñ) –≤ —ç—Ç–æ—Ç –∂–µ —á–∞—Ç.
      </div>
      
      <div id="err" class="error"></div>

      <button id="sendBtn" class="btn-primary">–û—Ç–ø—Ä–∞–≤–∏—Ç—å –∑–∞—è–≤–∫—É</button>
      
      <button onclick="goBack()" style="background:none; color:#888; font-size:14px; margin-top:5px;">
        ‚Üê –í–µ—Ä–Ω—É—Ç—å—Å—è –∫ –æ–ø–ª–∞—Ç–µ
      </button>
    </div>
  </div>

  <script>
    const tg = window.Telegram.WebApp;
    tg.ready();
    tg.expand();

    const mainButtonColor = tg.themeParams.button_color || "#2481cc";
    const mainButtonText = tg.themeParams.button_text_color || "#ffffff";
    const textColor = tg.themeParams.text_color || "#000";
    
    document.body.style.background = tg.themeParams.bg_color || "#f2f2f2"; 
    document.body.style.color = textColor;

    document.querySelectorAll('.btn-primary').forEach(b => {
        b.style.backgroundColor = mainButtonColor;
        b.style.color = mainButtonText;
    });
    document.querySelectorAll('.btn-outline').forEach(b => {
        b.style.borderColor = mainButtonColor;
        b.style.color = textColor;
    });
    
    document.querySelectorAll('.card').forEach(c => {
        c.style.backgroundColor = tg.themeParams.secondary_bg_color || "#ffffff";
        c.style.borderColor = "transparent"; 
    });

    const step1 = document.getElementById('step1');
    const step2 = document.getElementById('step2');

    const WEBHOOK_URL = 'https://www.maximdkh.ru/webhook/sneg-form'; 

    window.openPayment = (url) => { tg.openLink(url); };

    document.getElementById('goToFormBtn').onclick = () => {
        step1.classList.add('hidden');
        step2.classList.remove('hidden');
        tg.BackButton.show();
        tg.BackButton.onClick(goBack);
    };

    window.goBack = () => {
        step2.classList.add('hidden');
        step1.classList.remove('hidden');
        tg.BackButton.hide();
    };

    document.getElementById('askBtn').onclick = () => {
        const btn = document.getElementById('askBtn');
        btn.disabled = true;
        btn.textContent = "–°–æ–æ–±—â–∞—é –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä—É...";

        const payload = {
            type: "question",
            user: tg.initDataUnsafe?.user
        };

        fetch(WEBHOOK_URL, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(payload)
        })
        .then(() => {
            tg.close();
        })
        .catch(() => {
            alert("–û—à–∏–±–∫–∞ —Å–µ—Ç–∏. –ù–∞–ø–∏—à–∏—Ç–µ –ø—Ä–æ—Å—Ç–æ –≤ —á–∞—Ç.");
            tg.close();
        });
    };

    // --- –õ–û–ì–ò–ö–ê –§–û–†–ú–´ ---
    const plotEl = document.getElementById("plot");
    const amountEl = document.getElementById("amount");
    const collectionEl = document.getElementById("collection");
    const bankEl = document.getElementById("bank");
    const commentEl = document.getElementById("comment");
    const errEl = document.getElementById("err");
    const sendBtn = document.getElementById("sendBtn");

    function onlyDigits(s) { return String(s).replace(/[^\d]/g, ""); }
    function normAmount(s) { return String(s).replace(",", ".").replace(/[^\d.]/g, ""); }

    sendBtn.onclick = () => {
      errEl.textContent = "";

      // 1. –ü–û–õ–£–ß–ê–ï–ú –°–´–†–´–ï –î–ê–ù–ù–´–ï –î–õ–Ø –ü–†–û–í–ï–†–ö–ò
      const plotRaw = plotEl.value.trim();
      const bankRaw = bankEl.value.trim();
      const collection = collectionEl.value;
      const amountRaw = normAmount(amountEl.value);
      const amount = Number(amountRaw);

      // 2. –ü–†–û–í–ï–†–ö–ê –£–ß–ê–°–¢–ö–ê (–°–¢–†–û–ì–ê–Ø)
      // –ó–∞–ø—Ä–µ—â–∞–µ–º –∑–∞–ø—è—Ç—ã–µ, —Ç–æ—á–∫–∏ –∏ –ø—Ä–æ–±–µ–ª—ã, —á—Ç–æ–±—ã –Ω–µ –ø–∏—Å–∞–ª–∏ "12,13"
      if (plotRaw.includes(',') || plotRaw.includes('.') || plotRaw.includes(' ')) {
         return errEl.textContent = "–£–∫–∞–∂–∏ —Ç–æ–ª—å–∫–æ –æ–¥–∏–Ω –Ω–æ–º–µ—Ä —É—á–∞—Å—Ç–∫–∞ (–±–µ–∑ –∑–∞–ø—è—Ç—ã—Ö).";
      }
      
      const plot = onlyDigits(plotRaw);
      
      if (!plot) {
          return errEl.textContent = "–£–∫–∞–∂–∏ –Ω–æ–º–µ—Ä —É—á–∞—Å—Ç–∫–∞.";
      }
      // –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ –¥–ª–∏–Ω—É (–º–∞–∫—Å 3 –∑–Ω–∞–∫–∞)
      if (plot.length > 3) {
          return errEl.textContent = "–ù–æ–º–µ—Ä —É—á–∞—Å—Ç–∫–∞ –Ω–µ –º–æ–∂–µ—Ç –±—ã—Ç—å –¥–ª–∏–Ω–Ω–µ–µ 3 —Ü–∏—Ñ—Ä.";
      }

      // 3. –û–°–¢–ê–õ–¨–ù–´–ï –ü–†–û–í–ï–†–ö–ò
      if (!collection) return errEl.textContent = "–í—ã–±–µ—Ä–∏ –Ω–æ–º–µ—Ä —Å–±–æ—Ä–∞.";
      
      if (!amountRaw || !Number.isFinite(amount) || amount <= 0) {
          return errEl.textContent = "–£–∫–∞–∂–∏ –∫–æ—Ä—Ä–µ–∫—Ç–Ω—É—é —Å—É–º–º—É.";
      }

      // –ü—Ä–æ–≤–µ—Ä–∫–∞ –ë–∞–Ω–∫–∞ (—Ç–µ–ø–µ—Ä—å –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ–µ –ø–æ–ª–µ)
      if (!bankRaw) {
          return errEl.textContent = "–£–∫–∞–∂–∏ –±–∞–Ω–∫ –æ–ø–ª–∞—Ç—ã.";
      }

      const payload = {
        type: "payment_form",
        plot: Number(plot),
        collection: Number(collection),
        amount: Math.round(amount * 100) / 100,
        bank: bankRaw, // –ò—Å–ø–æ–ª—å–∑—É–µ–º –ø—Ä–æ–≤–µ—Ä–µ–Ω–Ω–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ
        comment: commentEl.value?.trim() || "",
        client_ts: new Date().toISOString(),
        user: tg.initDataUnsafe?.user
      };
      
      sendBtn.disabled = true;
      sendBtn.textContent = "–û—Ç–ø—Ä–∞–≤–∫–∞...";

      fetch(WEBHOOK_URL, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(payload)
      })
      .then(response => {
        if (response.ok) {
           tg.close(); 
        } else {
           errEl.textContent = "–û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞: " + response.status;
           sendBtn.disabled = false;
           sendBtn.textContent = "–û—Ç–ø—Ä–∞–≤–∏—Ç—å";
        }
      })
      .catch(error => {
        errEl.textContent = "–û—à–∏–±–∫–∞ —Å–µ—Ç–∏: " + error.message;
        sendBtn.disabled = false;
        sendBtn.textContent = "–û—Ç–ø—Ä–∞–≤–∏—Ç—å";
      });
    };
  </script>
</body>
</html>
