<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Сдача денег</title>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <style>
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial; margin: 0; padding: 16px; }
    h2 { margin: 8px 0 16px; }
    .card { border: 1px solid #ddd; border-radius: 14px; padding: 14px; }
    label { display:block; margin: 10px 0 6px; font-size: 14px; }
    input, select, textarea {
      width: 100%; box-sizing: border-box; padding: 10px 12px; border-radius: 10px;
      border: 1px solid #ccc; font-size: 16px;
    }
    textarea { min-height: 72px; }
    .row { display:flex; gap:10px; }
    .row > div { flex:1; }
    .error { color: #b00020; margin-top: 10px; font-size: 14px; }
    .hint { color:#666; font-size: 13px; margin-top: 8px; }
    button {
      width: 100%; margin-top: 14px; padding: 12px; font-size: 16px;
      border-radius: 12px; border: none; cursor: pointer;
    }
  </style>
</head>
<body>
  <h2>Сдача денег</h2>

  <div class="card">
    <div class="row">
      <div>
        <label>Участок *</label>
        <input id="plot" inputmode="numeric" placeholder="Например: 18" />
      </div>
      <div>
        <label>Сбор *</label>
        <select id="collection">
          <option value="">Выбери…</option>
          <option value="2">Сбор 2</option>
          <option value="3">Сбор 3</option>
        </select>
      </div>
    </div>

    <label>Сумма (₽) *</label>
    <input id="amount" inputmode="decimal" placeholder="Например: 1000" />

    <label>Банк </label>
    <input id="bank" placeholder="Сбер / Тинькофф / Наличные…" />

    <label>Комментарий (необязательно)</label>
    <textarea id="comment" placeholder="Например: за двоих / уточнение"></textarea>

    <div class="hint">После отправки бот попросит прислать чек (фото/пдф) в этот же чат.</div>
    <div id="err" class="error"></div>

    <button id="sendBtn">Отправить</button>
  </div>

  <script>
       const tg = window.Telegram.WebApp;
    tg.ready();

    document.body.style.background = tg.themeParams.bg_color || "#fff";
    document.body.style.color = tg.themeParams.text_color || "#000";

    const plotEl = document.getElementById("plot");
    const amountEl = document.getElementById("amount");
    const collectionEl = document.getElementById("collection");
    const bankEl = document.getElementById("bank");
    const commentEl = document.getElementById("comment");
    const errEl = document.getElementById("err");
    const sendBtn = document.getElementById("sendBtn");

    function onlyDigits(s) { return String(s).replace(/[^\d]/g, ""); }
    function normAmount(s) { return String(s).replace(",", ".").replace(/[^\d.]/g, ""); }

    sendBtn.onclick = () => {
      errEl.textContent = "";

      // --- 1. СНАЧАЛА ПОЛУЧАЕМ ДАННЫЕ (Этого не хватало) ---
      const plot = onlyDigits(plotEl.value);
      const collection = collectionEl.value;
      const amountRaw = normAmount(amountEl.value);
      const amount = Number(amountRaw);

      // --- 2. ПРОВЕРЯЕМ ОШИБКИ (ВАЛИДАЦИЯ) ---
      if (!plot) return errEl.textContent = "Укажи номер участка.";
      if (!collection) return errEl.textContent = "Выбери номер сбора.";
      if (!amountRaw || !Number.isFinite(amount) || amount <= 0) return errEl.textContent = "Укажи корректную сумму.";

      // --- 3. ФОРМИРУЕМ ОБЪЕКТ ДЛЯ ОТПРАВКИ ---
      const payload = {
        type: "payment_form",
        plot: Number(plot),
        collection: Number(collection),
        amount: Math.round(amount * 100) / 100,
        bank: bankEl.value?.trim() || "",
        comment: commentEl.value?.trim() || "",
        client_ts: new Date().toISOString(),
        user: tg.initDataUnsafe?.user // Данные о пользователе Telegram
      };
      
      // Блокируем кнопку, чтобы не нажали дважды
      sendBtn.disabled = true;
      sendBtn.textContent = "Отправка...";

      // --- 4. ОТПРАВЛЯЕМ В N8N (WEBHOOK) ---
      fetch('https://www.maximdkh.ru/webhook-test/sneg-form', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json'
        },
        body: JSON.stringify(payload)
      })
      .then(response => {
        if (response.ok) {
          // Если n8n ответил 200 OK
          tg.close(); 
        } else {
          // Если ошибка сервера
          errEl.textContent = "Ошибка сервера: " + response.status;
          sendBtn.disabled = false;
          sendBtn.textContent = "Отправить";
        }
      })
      .catch(error => {
        // Если нет интернета или адрес недоступен
        errEl.textContent = "Ошибка сети: " + error.message;
        sendBtn.disabled = false;
        sendBtn.textContent = "Отправить";
      });
    };
  </script>
</body>
</html>
